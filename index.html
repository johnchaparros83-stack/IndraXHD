<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual Educativo</title>
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.5/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const Assistant = () => {
            const [message, setMessage] = useState("");
            const [chat, setChat] = useState([{ sender: "assistant", text: "¡Hola! ¿Qué te gusta estudiar? Por ejemplo, ¿te apasionan las matemáticas, la escritura, la ciencia o prefieres algo creativo? Si no estás seguro, también puedo ayudarte a decidir." }]);
            const [isListening, setIsListening] = useState(false);
            const [formData, setFormData] = useState({ name: "", likes: "", dislikes: "", goal: "" });
            const [studyPlan, setStudyPlan] = useState(null);
            const [quote, setQuote] = useState(null);
            const [applicationForm, setApplicationForm] = useState(null);

            // Configuración de reconocimiento de voz
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = SpeechRecognition ? new SpeechRecognition() : null;

            useEffect(() => {
                if (recognition) {
                    recognition.lang = "es-ES";
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setMessage(transcript);
                        sendMessage(transcript);
                    };
                    recognition.onend = () => setIsListening(false);
                }
            }, []);

            const startListening = () => {
                if (recognition && !isListening) {
                    recognition.start();
                    setIsListening(true);
                }
            };

            const speak = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "es-ES";
                window.speechSynthesis.speak(utterance);
            };

            const sendMessage = async (input = message) => {
                if (!input) return;
                setChat([...chat, { sender: "user", text: input }]);

                try {
                    const response = await fetch("http://localhost:8000/assistant", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: input, formData })
                    });
                    const data = await response.json();
                    setChat([...chat, { sender: "user", text: input }, { sender: "assistant", text: data.response }]);
                    if (data.studyPlan) setStudyPlan(data.studyPlan);
                    if (data.quote) setQuote(data.quote);
                    if (data.applicationForm) setApplicationForm(data.applicationForm);
                    speak(data.response);
                } catch (error) {
                    const errorMsg = "Error al conectar con el servidor.";
                    setChat([...chat, { sender: "user", text: input }, { sender: "assistant", text: errorMsg }]);
                    speak(errorMsg);
                }
                setMessage("");
            };

            const handleFormChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const submitForm = async () => {
                const response = await fetch("http://localhost:8000/form", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                setChat([...chat, { sender: "assistant", text: data.response }]);
                setApplicationForm(data.applicationForm);
                speak(data.response);
            };

            return (
                <div className="bg-gray-100 min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
                        <h1 className="text-2xl font-bold mb-4 text-center">Asistente Virtual Educativo</h1>
                        <div className="h-64 overflow-y-auto border p-4 mb-4 bg-gray-50">
                            {chat.map((msg, index) => (
                                <p key={index} className={msg.sender === "user" ? "text-blue-600" : "text-gray-800"}>
                                    <strong>{msg.sender === "user" ? "Tú" : "Asistente"}:</strong> {msg.text}
                                </p>
                            ))}
                        </div>
                        <div className="flex mb-4">
                            <input
                                type="text"
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                className="flex-1 p-2 border rounded-l-lg"
                                placeholder="Escribe o usa voz..."
                                onKeyPress={(e) => e.key === "Enter" && sendMessage()}
                            />
                            <button onClick={sendMessage} className="bg-blue-500 text-white p-2">Enviar</button>
                            <button onClick={startListening} className={`p-2 ${isListening ? "bg-red-500" : "bg-green-500"} text-white rounded-r-lg`}>
                                {isListening ? "Escuchando..." : "Hablar"}
                            </button>
                        </div>
                        <div className="mb-4">
                            <h2 className="text-lg font-semibold">Cuéntame sobre ti</h2>
                            <input
                                type="text"
                                name="name"
                                value={formData.name}
                                onChange={handleFormChange}
                                className="w-full p-2 border rounded mb-2"
                                placeholder="Tu nombre"
                            />
                            <input
                                type="text"
                                name="likes"
                                value={formData.likes}
                                onChange={handleFormChange}
                                className="w-full p-2 border rounded mb-2"
                                placeholder="¿Qué te gusta? (e.g., escritura, ciencia)"
                            />
                            <input
                                type="text"
                                name="dislikes"
                                value={formData.dislikes}
                                onChange={handleFormChange}
                                className="w-full p-2 border rounded mb-2"
                                placeholder="¿Qué no te gusta? (e.g., matemáticas)"
                            />
                            <input
                                type="text"
                                name="goal"
                                value={formData.goal}
                                onChange={handleFormChange}
                                className="w-full p-2 border rounded mb-2"
                                placeholder="¿Tienes un objetivo? (e.g., carrera, curso)"
                            />
                            <button onClick={submitForm} className="bg-blue-500 text-white p-2 rounded w-full">Enviar datos</button>
                        </div>
                        {studyPlan && (
                            <div className="mb-4">
                                <h2 className="text-lg font-semibold">Plan de Estudio</h2>
                                <ul className="list-disc pl-5">
                                    {studyPlan.tasks.map((task, index) => (
                                        <li key={index}>{task}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        {quote && (
                            <div className="mb-4">
                                <h2 className="text-lg font-semibold">Cotización</h2>
                                <p>Total estimado: ${quote.total}</p>
                                <ul className="list-disc pl-5">
                                    {quote.items.map((item, index) => (
                                        <li key={index}>{item.name}: ${item.cost}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        {applicationForm && (
                            <div>
                                <h2 className="text-lg font-semibold">Formulario de Postulación</h2>
                                {applicationForm.fields.map((field, index) => (
                                    <div key={index} className="mb-2">
                                        <label className="block">{field.label}</label>
                                        <input
                                            type="text"
                                            value={field.value}
                                            onChange={(e) => {
                                                const newFields = [...applicationForm.fields];
                                                newFields[index].value = e.target.value;
                                                setApplicationForm({ ...applicationForm, fields: newFields });
                                            }}
                                            className="w-full p-2 border rounded"
                                            placeholder={field.placeholder}
                                        />
                                    </div>
                                ))}
                                <button
                                    onClick={async () => {
                                        const response = await fetch("http://localhost:8000/submit_application", {
                                            method: "POST",
                                            headers: { "Content-Type": "application/json" },
                                            body: JSON.stringify({ form: applicationForm })
                                        });
                                        const data = await response.json();
                                        setChat([...chat, { sender: "assistant", text: data.response }]);
                                        speak(data.response);
                                    }}
                                    className="bg-blue-500 text-white p-2 rounded w-full"
                                >
                                    Enviar Postulación
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Assistant />, document.getElementById("root"));
    </script>
</body>
</html>